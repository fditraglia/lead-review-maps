---
title: "Final Results"
author: "Frank"
format: pdf 
---


```{r}
#| message: false
#| warning: false
library(sf)
library(tidyverse)
library(gridExtra)
library(GGally)

# Load shapefiles merged with lead data
load('data/bllWorld.RData')
load('data/bllGBD.RData')

# Set ggplot theme
theme_set(theme_bw())

# Fraction with BLL > 5 micrograms / deciliter
frac5plus <- bllWorld |> 
  ggplot() + 
  geom_sf(aes(fill = 100 * frac5plus)) +
  scale_fill_viridis_c(option = "plasma", trans = "sqrt", name = '% >5') +
  labs(title = 'BLL > 5 micrograms/dl')

# Fraction with BLL > 10 micrograms / deciliter
frac10plus <- bllWorld |> 
  ggplot() + 
  geom_sf(aes(fill = 100 * frac10plus)) +
  scale_fill_viridis_c(option = "plasma", trans = "sqrt", name = '% >10') +
  labs(title = 'BLL > 10 micrograms/dl')

grid.arrange(frac5plus, frac10plus, nrow = 2, 
             bottom = 'Estimated percentage of population aged 0-19 with elevated BLL')

# The IQ loss results are highly correlated across beta, lognormal, and lower
# bound approaches
bllGBD |> 
  select(LB_IQ_integral, beta_IQ_integral, lnorm_IQ_integral) |> 
  ggpairs()

# Dollar value of IQ loss, with missing values from missing returns to education
bllWorld |> 
  ggplot() + 
  geom_sf(aes(fill = dollars_per_IQ * beta_IQ_integral)) +
  scale_fill_viridis_c(option = "plasma", name = '$US', trans = 'sqrt') +
  labs(title = 'Dollar value of IQ loss')

# Check that this isn't just a plot of gdp/capita
bllWorld |> 
  ggplot() + 
  geom_sf(aes(fill = gdpc)) +
  scale_fill_viridis_c(option = "plasma", name = '$US', trans = 'sqrt') +
  labs(title = 'GDP per capita: PPP, 2019 $US')

# Check which continent Greenland is assigned to
bllWorld |> 
  filter(gu_a3 == 'GRL') |> 
  select(gu_a3, continent)

# Replace the missing values with the geometric mean of the continent average
gm_mean <- function(x, na.rm=TRUE){
  exp(sum(log(x[x > 0]), na.rm=na.rm) / length(x))
}

bllWorld <- bllWorld |> 
  group_by(continent) |> 
  mutate(dollars_per_IQ_continent = gm_mean(dollars_per_IQ)) |> 
  ungroup() |> 
  mutate(dollars_per_IQ = if_else(!is.na(dollars_per_IQ),
                                  dollars_per_IQ, 
                                  dollars_per_IQ_continent)) |> 
  # It doesn't make sense to compute this average for Greenland since
  # its continent is North America
  mutate(dollars_per_IQ = if_else(gu_a3 == 'GRL', NA, 
                                  dollars_per_IQ)) 

bllWorld |> 
  ggplot() + 
  geom_sf(aes(fill = dollars_per_IQ * beta_IQ_integral)) +
  scale_fill_viridis_c(option = "plasma", name = '$US', trans = 'sqrt') +
  labs(title = 'Dollar value of IQ loss')

# Compute dollar value of IQ loss: per person, lifetime discounted 
bllGBD |> 
  filter(!is.na(dollars_per_IQ)) |>  
  summarize(lower_bound = sum(dollars_per_IQ * popn0019 * LB_IQ_integral) / sum(popn0019),
            beta_approx = sum(dollars_per_IQ * popn0019 * beta_IQ_integral) / sum(popn0019),
            lnorm_approx = sum(dollars_per_IQ * popn0019 * lnorm_IQ_integral) / sum(popn0019))
```

